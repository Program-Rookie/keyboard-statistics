好的，我们来设计这个“健康风险评估”功能，包括需求细节和技术实现思路。

**目标:** 提供一个**基于用户输入（可选）和已记录的按键统计数据**的、**简单的、非医疗性质的**健康风险提示，旨在提高用户对潜在 RSI (重复性劳损) 风险的意识。**重点强调：这不是医疗诊断。**

---

**1. 需求内容 (Requirements - 细化 FR11)**

*   **FR11.1: 用户可选信息输入 (User Profile Input - Optional):**
    *   在专门的“健康洞察”界面区域，提供以下**可选**输入字段：
        *   **职业/主要电脑用途 (Profession/Primary Use):** 文本输入框或下拉选择框（例如：程序员、作家/编辑、数据录入、游戏玩家、学生、行政办公、休闲/浏览）。此信息用于提供一点点上下文，但不会用于复杂的逻辑。
        *   **平均每日电脑使用时长 (Avg. Daily Computer Use):** 下拉选择框（例如：< 2小时, 2-4小时, 4-6小时, 6-8小时, > 8小时）。
    *   提供一个“保存资料”按钮，将这些信息存储在本地。
    *   明确标注这些信息是**完全可选**的，不填写也能获得基于按键数据的评估。

*   **FR11.2: 风险评估指标来源 (Assessment Input Metrics):**
    *   评估算法将主要基于以下从**已记录数据**中计算得出的指标（按日或按周聚合）：
        *   **总按键数 (Total Keystrokes):** 例如，日均按键数、周总按键数。
        *   **按键强度 (Intensity - KPM):** 例如，日/周平均 KPM、高峰 KPM 出现的频率或持续时间。
        *   **连续输入时长 (Continuous Typing Duration):** 需要算法识别并统计持续按键（中间无明显停顿）的时间段长度和频率。需要定义“明显停顿”（例如，超过 5 分钟无按键）。
    *   评估算法会**参考**用户提供的可选信息（如每日使用时长）来调整提示的语气或侧重点，但核心判断基于按键数据。

*   **FR11.3: 风险评估算法 (Assessment Algorithm - Rule-Based):**
    *   采用**简单的、基于规则 (Rule-Based)** 的算法。**不使用**复杂的、不透明的机器学习模型（至少在 V1 不考虑）。
    *   定义一系列**阈值**来判断各项指标是否处于“较高”水平（这些阈值需要初步设定，未来可能需要根据用户反馈调整）：
        *   `THRESHOLD_DAILY_KEYS_HIGH` (例如: 30000)
        *   `THRESHOLD_AVG_KPM_HIGH` (例如: 60)
        *   `THRESHOLD_CONTINUOUS_SESSION_LONG` (例如: 60分钟)
        *   `THRESHOLD_FREQUENT_LONG_SESSIONS` (例如: 每日超过 2 次长时段连续输入)
    *   根据指标是否达到阈值，设置不同的**风险标志 (Risk Flags)**。
    *   根据触发的风险标志数量和类型，以及参考用户提供的可选信息，生成**分级的文本提示**。

*   **FR11.4: 评估结果呈现 (Assessment Output):**
    *   在“健康洞察”界面的指定区域（例如，用户资料下方），显示一个**只读的文本框**。
    *   根据算法结果，显示不同层级的评估文本，例如：
        *   **低风险提示:** "根据您过去一周的数据，您的键盘使用强度似乎在适度范围内。保持良好的习惯，记得定时休息！"
        *   **中风险提示:** "数据显示您有较高的按键频率 [或: 较长的连续输入时段]。这可能增加手部疲劳的风险。建议增加短暂休息的频率，并注意打字姿势。"
        *   **较高风险提示:** "您的键盘活动数据显示多项潜在风险因素（例如：高按键量和长时间连续输入）。强烈建议您重视规律休息、进行伸展活动，并检查您的人体工学设置（如座椅、键盘位置）。"
        *   *(可以根据具体触发的标志，稍微定制提示内容，例如“特别是长时间的连续输入需要注意…”)*
    *   评估结果应定期（例如，每日）自动更新，或者提供一个手动“重新评估”按钮。

*   **FR11.5: 强制性免责声明 (Mandatory Disclaimer):**
    *   在评估结果文本的**正下方或紧邻位置**，必须以**清晰、醒目**的方式显示免责声明，内容类似：
        *   **"重要提示：本评估仅为基于统计数据的通用性提示，旨在提高健康意识，不能替代专业的医疗诊断或建议。如果您感到任何不适，请咨询医生或专业人士。"**

---

**2. 技术实现思路 (Technical Implementation)**

*   **2.1 数据处理与指标计算:**
    *   你需要编写额外的**数据处理逻辑**来计算评估所需的指标。这可能在数据存储（例如 SQLite）层面通过 SQL 查询完成，或者在应用程序逻辑层面处理。
    *   **计算日/周聚合数据:**
        *   总按键数：简单的 COUNT 查询，按天/周分组。
        *   平均 KPM：计算总按键数 / 总活跃分钟数（需要定义如何计算活跃分钟，例如有按键发生的分钟）。
    *   **识别连续输入时段 (关键且稍复杂):**
        *   需要遍历按时间排序的按键事件记录。
        *   维护一个“当前会话”开始时间和最后按键时间。
        *   如果两个连续按键事件的时间差小于“中断阈值”（例如 5 分钟），则认为会话继续。
        *   如果时间差大于阈值，则结束上一个会话，记录其时长，并开始新会话。
        *   统计这些会话的长度分布和频率。
    *   这些计算可以在每次应用启动时对前一天/周的数据进行处理并缓存结果，或者在用户切换到“健康洞察”页面时按需计算（如果数据量不大）。

*   **2.2 规则引擎实现:**
    *   可以用简单的 `if-else` 语句或 `switch` 结构来实现规则判断。
    *   定义一个函数 `calculateHealthRisk(metrics, userProfile)`:
        *   输入参数是计算好的指标 (`metrics`) 和用户资料 (`userProfile`)。
        *   内部根据预设的阈值判断 `metrics`，设置 `riskFlags` (例如 `isVolumeHigh`, `isIntensityHigh`, `hasLongSessions`)。
        *   计算风险标志的总数 `numberOfFlags`。
        *   参考 `userProfile` 中的信息（例如，如果 `userProfile.dailyUse` 是 '> 8小时' 且 `isVolumeHigh`，可以增加风险权重或调整措辞）。
        *   根据 `numberOfFlags` 和具体的 `riskFlags`，返回对应的预设文本消息（包括免责声明）。

*   **2.3 用户资料存储:**
    *   将用户输入的职业和使用时长信息存储在本地的配置文件或数据库中，与应用的其它设置放在一起。确保这部分数据也能被用户通过“删除所有数据”功能清除（如果用户期望）。

*   **2.4 UI 集成:**
    *   在“健康洞察”界面创建输入框/下拉菜单和保存按钮。
    *   创建一个只读文本区域来显示评估结果。
    *   在合适的时机（如应用启动、切换到该页面、点击“保存资料”后、或点击“重新评估”按钮）调用 `calculateHealthRisk` 函数，并将返回的文本更新到 UI 上。

*   **2.5 阈值调整:**
    *   将风险评估的阈值定义为常量或配置项，方便后续根据用户反馈进行调整，而无需修改核心代码逻辑。